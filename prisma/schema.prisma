generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                   String         @id @default(uuid())
  email                String         @unique
  username             String?
  password             String
  role                 Role           @default(USER)
  refreshToken         String?
  refreshTokenExpires  DateTime?
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  totpSecret           String?
  totpEnabled          Boolean        @default(false)
  totpRecoveryCodes    String[]       @default([])
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  JobTrack             JobTrack[]
  UserTracking         UserTracking[]

  @@map("Utilisateurs")
}

enum Role {
  ADMIN
  USER
}

model JobTrack {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  title        String
  company      String?
  jobUrl       String?
  appliedAt    DateTime?
  status       JobStatus     @default(APPLIED)
  contractType ContractType?

  notes       String?
  cvFileName  String?
  lmFileName  String?

  reminders Reminder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("Annonces")
}

enum JobStatus {
  APPLIED
  PENDING
  INTERVIEW
  REJECTED
  ACCEPTED
}

enum ContractType {
  CDI
  CDD
  INTERIM
  STAGE
  ALTERNANCE
  FREELANCE
}

model Reminder {
  id         String   @id @default(uuid())
  jobtrack   JobTrack @relation(fields: [jobTrackId], references: [id], onDelete: Cascade)
  jobTrackId String

  frequency      Int
  nextReminderAt DateTime
  lastSentAt     DateTime?
  isActive       Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobTrackId])
  @@index([isActive, nextReminderAt])
  @@map("Relance")
}

model UserTracking {
  id                     String    @id @default(uuid())
  user                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                 String
  totalApplications      Int       @default(0) // Nombre total de candidatures
  totalRemindersSent     Int       @default(0) // Nombre total de relances envoyées
  applicationsPerStatus  Json      @default("{}") // Répartition par statut, ex: { "APPLIED": 3, "INTERVIEW": 1, "REJECTED": 2 }
  lastActionAt           DateTime? // Dernière action utilisateur
  responseRate           Float?    @default(0.0) // Taux de réponses reçues (0.0 à 1.0)
  remindersEffectiveness Float?    @default(0.0) // Taux de relances effectuées
  avgResponseTime        Float?    @default(0.0) // Temps moyen entre candidature et réponse (en jours)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
}

model VerificationCode {
  id        String   @id @default(uuid())
  email     String   @unique
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("CodesVerification")
}

model PendingUser {
  id       String  @id @default(uuid())
  email    String  @unique
  username String?
  password String // Mot de passe hashé (bcrypt)
  verified Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("UtilisateursEnAttente")
}
